<h2>Gerenciador de Tarefas</h2>
<p>Adicione, gerencie e remova suas tarefas.</p>

<form id="form-criar-tarefa">
  <div class="form-group">
    <label for="titulo">Título da Tarefa:</label>
    <input type="text" id="titulo" name="titulo" required placeholder="Ex: Corrigir bug na API...">
  </div>
  <div class="form-group">
    <label for="descricao">Descrição (Opcional):</label>
    <textarea id="descricao" name="descricao" placeholder="Ex: O endpoint /users está..."></textarea>
  </div>
  <button type="submit" class="btn">Adicionar Tarefa</button>
</form>

<h2 style="margin-top: 2rem;">Tarefas Pendentes</h2>

<div id="lista-tarefas">
  <% if (tarefas.length > 0) { %>
    <% tarefas.forEach(tarefa => { %>
      <div class="list-item" id="tarefa-<%= tarefa._id %>">
        <div class="item-content">
          <h3><%= tarefa.titulo %></h3>
          <p><%= tarefa.descricao || 'Sem descrição' %> (Status: <%= tarefa.status %>)</p>
        </div>
        <div class="item-actions">
          <button class="btn btn-delete" onclick="removerTarefa('<%= tarefa._id %>')">Concluir & Remover</button>
        </div>
      </div>
    <% }) %>
  <% } else { %>
    <p id="sem-tarefas">Nenhuma tarefa encontrada. Adicione uma nova!</p>
  <% } %>
</div>

<script>
  // Script para lidar com a criação de tarefas via API
  document.getElementById('form-criar-tarefa').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const titulo = document.getElementById('titulo').value;
    const descricao = document.getElementById('descricao').value;

    try {
      const response = await fetch('/api/mongodb/tarefas', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ titulo, descricao, status: 'pendente' }),
      });

      if (!response.ok) {
        const err = await response.json();
        throw new Error(err.message || 'Falha ao criar tarefa');
      }
      
      // Recarrega a página para mostrar a nova tarefa
      location.reload();

    } catch (error) {
      console.error('Erro:', error);
      alert(error.message);
    }
  });

  // Script para remover tarefa via API
  async function removerTarefa(id) {
    if (!confirm('Tem certeza que deseja remover esta tarefa?')) {
      return;
    }

    try {
      const response = await fetch(`/api/mongodb/tarefas/${id}`, {
        method: 'DELETE',
      });

      if (!response.ok) {
        const err = await response.json();
        throw new Error(err.message || 'Falha ao remover tarefa');
      }

      // Remove o item da UI
      const itemElement = document.getElementById(`tarefa-${id}`);
      if (itemElement) {
        itemElement.remove();
      }

      // Verifica se a lista está vazia
      const lista = document.getElementById('lista-tarefas');
      if (lista.getElementsByClassName('list-item').length === 0) {
        const msg = document.getElementById('sem-tarefas');
        if (msg) msg.style.display = 'block';
      }

    } catch (error) {
      console.error('Erro:', error);
      alert(error.message);
    }
  }
</script>