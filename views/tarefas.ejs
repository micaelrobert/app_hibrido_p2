<%- contentFor('body') %>

<div class="container-lista">
  <div class="terminal-header">
    <div class="terminal-title">system@tarefas:~</div>
    <div class="terminal-controls">
      <div class="control-btn minimize"></div>
      <div class="control-btn maximize"></div>
      <div class="control-btn close"></div>
    </div>
  </div>

  <div class="terminal-body">
    <h1 class="glitch" data-text="[ Lista de Tarefas ]">[ Lista de Tarefas ]</h1>
    <p class="console-text">C:\\> Gerenciando_protocolos_de_tarefas...</p>

    <form id="form-nova-tarefa" class="form-hacker">
      <div class="form-group">
        <label for="nome-tarefa" class="console-label">>> Nova Tarefa:</label>
        <input
          type="text"
          id="nome-tarefa"
          name="nome"
          class="form-input"
          placeholder="Descrever tarefa..."
          required
        />
      </div>
      <div class="form-group">
        <label for="prioridade-tarefa" class="console-label">>> Prioridade:</label>
        <select id="prioridade-tarefa" name="prioridade" class="form-input" required>
          <option value="Baixa">Baixa</option>
          <option value="Media" selected>Média</option>
          <option value="Alta">Alta</option>
        </select>
      </div>

      <div class="form-group">
        <label for="projeto-tarefa" class="console-label">>> Projeto:</label>
        <select id="projeto-tarefa" name="projeto" class="form-input">
          <option value="">[ Sem Projeto ]</option>
          <% if (projetos && projetos.length > 0) { %>
            <% projetos.forEach(projeto => { %>
              <% if (!projeto.concluido) { %> 
                <option value="<%= projeto._id %>"><%= projeto.nome %></option>
              <% } %>
            <% }) %>
          <% } %>
        </select>
      </div>
      
      <button type="submit" class="btn-hacker">[ Adicionar Tarefa ]</button>
    </form>

    <ul id="lista-tarefas" class="lista-hacker">
      <% if (tarefas && tarefas.length > 0) { %>
        <% tarefas.forEach(tarefa => { %>
          <li
            class="item-lista prioridade-<%= tarefa.prioridade.toLowerCase() %> <%= tarefa.concluido ? 'concluido' : '' %>"
            data-id="<%= tarefa._id %>"
            data-concluido="<%= tarefa.concluido %>"
          >
            <span class="item-texto">
              <strong class="item-nome">[<%= tarefa.nome %>]</strong>
              
              <% if (tarefa.tags && tarefa.tags.length > 0) { %>
                <span class="item-detalhe" style="color: #ff00ff;"> { tags: [<%= tarefa.tags.join(', ') %>] } </span>
              <% } %>

              <% if (tarefa.projeto) { %>
                <span class="item-detalhe" style="color: #00ffff;">- Projeto: <%= tarefa.projeto.nome %></span>
              <% } %>
              
              <span class="item-detalhe">- Prioridade: <%= tarefa.prioridade %></span>
              <span class="item-data">(Criada em: <%= new Date(tarefa.dataCriacao).toLocaleDateString('pt-BR') %>)</span>
            </span> 
            
            <div class="botoes-item">
              <button class="btn-acao btn-tag" onclick="adicionarTag('<%= tarefa._id %>')">[ +Tag ]</button>

              <% if (tarefa.prioridade !== 'Alta') { %>
                <button class="btn-acao btn-urgente" onclick="marcarUrgente('<%= tarefa._id %>')">[ !Urgente! ]</button>
              <% } %>

              <button class="btn-acao btn-concluir">
                <%= tarefa.concluido ? '[ Reabrir ]' : '[ Concluir ]' %>
              </button>
              <button class="btn-acao btn-apagar">[ Apagar ]</button>
            </div>
          </li>
        <% }) %>
      <% } else { %>
        <li id="sem-tarefas" class="console-text">>> Nenhuma tarefa encontrada. Sistema ocioso...</li>
      <% } %>
    </ul>
  </div>
</div>

<script>
  // --- FUNÇÕES GLOBAIS PARA AS NOVAS TAREFAS ---

  // Tarefa 2: Função para adicionar tag via prompt
  async function adicionarTag(id) {
    const tag = prompt("C:\\> Digite a nova tag para adicionar:");
    if (!tag) return;

    try {
      const response = await fetch(`/api/mongodb/tarefas/${id}/tags`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tag }),
      });

      if (response.ok) {
        window.location.reload(); // Recarrega para mostrar a tag
      } else {
        const data = await response.json();
        alert('Erro: ' + (data.error || 'Falha ao adicionar tag'));
      }
    } catch (error) {
      console.error('Erro:', error);
      alert('Erro de conexão.');
    }
  }

  // Tarefa 4: Função para marcar como urgente
  async function marcarUrgente(id) {
    if (!confirm("C:\\> ATENÇÃO: Transformar esta tarefa em Prioridade ALTA e adicionar tag 'urgente'?")) {
      return;
    }

    try {
      const response = await fetch(`/api/mongodb/tarefas/${id}/urgente`, {
        method: 'PUT'
      });

      if (response.ok) {
        window.location.reload();
      } else {
        alert('Erro ao marcar como urgente.');
      }
    } catch (error) {
      console.error('Erro:', error);
    }
  }

  // --- LÓGICA EXISTENTE ---

  // Adicionar Tarefa
  document.getElementById('form-nova-tarefa').addEventListener('submit', async function (e) {
    e.preventDefault();
    
    const nome = this.elements.nome.value;
    const prioridade = this.elements.prioridade.value;
    const projeto = this.elements.projeto.value;

    try {
      const response = await fetch('/api/mongodb/tarefas', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nome, prioridade, projeto: projeto || null }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Falha ao criar tarefa.');
      }

      const novaTarefa = await response.json();
      adicionarTarefaNaLista(novaTarefa);

      this.reset();
      this.elements.nome.focus();

    } catch (error) {
      console.error('Erro ao adicionar tarefa:', error);
      alert('Erro: ' + error.message);
    }
  });

  // Adiciona listeners aos botões de Concluir e Apagar
  function adicionarListenersAosBotoes(itemLista) {
    // Botão Concluir/Reabrir
    itemLista.querySelector('.btn-concluir').addEventListener('click', async (e) => {
      const li = e.target.closest('li');
      const id = li.dataset.id;
      const isConcluido = li.dataset.concluido === 'true';
      
      try {
        const response = await fetch(`/api/mongodb/tarefas/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ concluido: !isConcluido }),
        });

        if (!response.ok) {
          throw new Error('Falha ao atualizar tarefa.');
        }

        const { data } = await response.json();
        
        li.dataset.concluido = data.concluido;
        li.classList.toggle('concluido', data.concluido);
        e.target.textContent = data.concluido ? '[ Reabrir ]' : '[ Concluir ]';

      } catch (error) {
        console.error('Erro ao concluir tarefa:', error);
        alert('Erro: ' + error.message);
      }
    });

    // Botão Apagar
    itemLista.querySelector('.btn-apagar').addEventListener('click', async (e) => {
      const li = e.target.closest('li');
      const id = li.dataset.id;

      if (!confirm(`C:\\> Tem certeza que deseja apagar a tarefa "${li.querySelector('.item-nome').textContent}"? Esta ação é irreversível.`)) {
        return;
      }

      try {
        const response = await fetch(`/api/mongodb/tarefas/${id}`, {
          method: 'DELETE',
        });

        if (!response.ok) {
          throw new Error('Falha ao apagar tarefa.');
        }

        li.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
        li.style.opacity = '0';
        li.style.transform = 'translateX(-100%)';
          
        setTimeout(() => {
          li.remove();
          const lista = document.getElementById('lista-tarefas');
          if (lista.children.length === 0) {
            lista.innerHTML = '<li id="sem-tarefas" class="console-text">>> Nenhuma tarefa encontrada. Sistema ocioso...</li>';
          }
        }, 500);
      } catch (error) {
        console.error('Erro ao apagar tarefa:', error);
        alert('Erro: ' + error.message);
      }
    });
  }

  // Adiciona listeners para os itens já carregados na página
  document.querySelectorAll('#lista-tarefas .item-lista').forEach(adicionarListenersAosBotoes);

  // Função para adicionar nova tarefa na lista (DOM)
  function adicionarTarefaNaLista(tarefa) {
    const semTarefas = document.getElementById('sem-tarefas');
    if (semTarefas) {
      semTarefas.remove();
    }

    const li = document.createElement('li');
    li.className = `item-lista prioridade-${tarefa.prioridade.toLowerCase()}`;
    li.dataset.id = tarefa._id;
    li.dataset.concluido = 'false';

    const projetoHtml = tarefa.projeto
      ? `<span class="item-detalhe" style="color: #00ffff;">- Projeto: ${tarefa.projeto.nome}</span>`
      : '';

    // Botão urgente condicional
    const btnUrgenteHtml = tarefa.prioridade !== 'Alta' 
      ? `<button class="btn-acao btn-urgente" onclick="marcarUrgente('${tarefa._id}')">[ !Urgente! ]</button>`
      : '';

    li.innerHTML = `
      <span class="item-texto">
        <strong class="item-nome">[${tarefa.nome}]</strong>
        ${projetoHtml}
        <span class="item-detalhe">- Prioridade: ${tarefa.prioridade}</span>
        <span class="item-data">(Criada em: ${new Date(tarefa.dataCriacao).toLocaleDateString('pt-BR')})</span>
      </span>
      <div class="botoes-item">
        <button class="btn-acao btn-tag" onclick="adicionarTag('${tarefa._id}')">[ +Tag ]</button>
        ${btnUrgenteHtml}
        <button class="btn-acao btn-concluir">[ Concluir ]</button>
        <button class="btn-acao btn-apagar">[ Apagar ]</button>
      </div>
    `;

    document.getElementById('lista-tarefas').prepend(li);
    adicionarListenersAosBotoes(li);
  }
</script>