<%- include('layout', { titulo: titulo, appName: 'App H√≠brido' }) %>
<%- include('partials/header') %>

<div class="container">
    <div class="page-header card">
        <div style="font-size: 4rem; margin-bottom: 20px;">üìÅ</div>
        <h2>Categorias e Projetos</h2>
        <p>Organize suas tarefas em categorias personalizadas</p>
    </div>

    <div class="card">
        <h3 style="margin-bottom: 20px;">‚ûï Nova Categoria</h3>
        <form id="categoryForm">
            <div class="form-group">
                <label for="nome">Nome da Categoria *</label>
                <input 
                    type="text" 
                    id="nome" 
                    name="nome" 
                    placeholder="Ex: Desenvolvimento, Estudos, Pessoal..."
                    required
                >
            </div>
            
            <div class="form-group">
                <label for="descricao">Descri√ß√£o</label>
                <textarea 
                    id="descricao" 
                    name="descricao" 
                    placeholder="Descreva o prop√≥sito desta categoria... (opcional)"
                    rows="3"
                ></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="cor">Cor da Categoria</label>
                    <input 
                        type="color" 
                        id="cor" 
                        name="cor" 
                        value="#60a5fa"
                    >
                    <div class="color-preview" id="colorPreview">
                        <span id="previewIcon">üìÅ</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Escolha um √çcone</label>
                    <div class="icon-selector">
                        <div class="icon-option active" data-icon="üìÅ">üìÅ</div>
                        <div class="icon-option" data-icon="üíª">üíª</div>
                        <div class="icon-option" data-icon="üìö">üìö</div>
                        <div class="icon-option" data-icon="üè†">üè†</div>
                        <div class="icon-option" data-icon="üíº">üíº</div>
                        <div class="icon-option" data-icon="üéØ">üéØ</div>
                        <div class="icon-option" data-icon="üé®">üé®</div>
                        <div class="icon-option" data-icon="üèÉ">üèÉ</div>
                        <div class="icon-option" data-icon="üçî">üçî</div>
                        <div class="icon-option" data-icon="üéÆ">üéÆ</div>
                        <div class="icon-option" data-icon="‚úàÔ∏è">‚úàÔ∏è</div>
                        <div class="icon-option" data-icon="‚ù§Ô∏è">‚ù§Ô∏è</div>
                    </div>
                    <input type="hidden" id="icone" name="icone" value="üìÅ">
                </div>
            </div>
            
            <button type="submit" class="btn">
                ‚ú® Criar Categoria
            </button>
        </form>
    </div>

    <div class="card">
        <h3 style="margin-bottom: 20px;">üìÇ Minhas Categorias</h3>
        
        <div id="categoriesContainer" class="categories-grid">
            <div style="text-align: center; padding: 40px;">
                <p>Carregando categorias...</p>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="editModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚úèÔ∏è Editar Categoria</h3>
            <button class="modal-close" onclick="closeEditModal()">√ó</button>
        </div>
        <form id="editCategoryForm">
            <input type="hidden" id="edit_id">
            
            <div class="form-group">
                <label for="edit_nome">Nome da Categoria *</label>
                <input type="text" id="edit_nome" name="nome" required>
            </div>
            
            <div class="form-group">
                <label for="edit_descricao">Descri√ß√£o</label>
                <textarea id="edit_descricao" name="descricao" rows="3"></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="edit_cor">Cor</label>
                    <input type="color" id="edit_cor" name="cor">
                    <div class="color-preview" id="editColorPreview">
                        <span id="editPreviewIcon">üìÅ</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>√çcone</label>
                    <div class="icon-selector" id="editIconSelector">
                        <div class="icon-option" data-icon="üìÅ">üìÅ</div>
                        <div class="icon-option" data-icon="üíª">üíª</div>
                        <div class="icon-option" data-icon="üìö">üìö</div>
                        <div class="icon-option" data-icon="üè†">üè†</div>
                        <div class="icon-option" data-icon="üíº">üíº</div>
                        <div class="icon-option" data-icon="üéØ">üéØ</div>
                        <div class="icon-option" data-icon="üé®">üé®</div>
                        <div class="icon-option" data-icon="üèÉ">üèÉ</div>
                        <div class="icon-option" data-icon="üçî">üçî</div>
                        <div class="icon-option" data-icon="üéÆ">üéÆ</div>
                        <div class="icon-option" data-icon="‚úàÔ∏è">‚úàÔ∏è</div>
                        <div class="icon-option" data-icon="‚ù§Ô∏è">‚ù§Ô∏è</div>
                    </div>
                    <input type="hidden" id="edit_icone" name="icone">
                </div>
            </div>
            
            <button type="submit" class="btn" style="margin-top: 20px;">
                üíæ Salvar Altera√ß√µes
            </button>
        </form>
    </div>
</div>

<script>
    // Estado global
    let selectedIcon = 'üìÅ';
    let selectedColor = '#60a5fa';
    let editingCategoryId = null;
    let editSelectedIcon = 'üìÅ';
    let editSelectedColor = '#60a5fa';

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
        setupIconSelector();
        setupColorPicker();
        setupCategoryForm();
        setupEditForm();
        loadCategories();
    });

    // ====================================================================
    // SELETOR DE √çCONES
    // ====================================================================
    function setupIconSelector() {
        const iconOptions = document.querySelectorAll('.icon-selector .icon-option');
        iconOptions.forEach(option => {
            option.addEventListener('click', function() {
                const isEdit = this.closest('#editIconSelector');
                const selector = isEdit ? '#editIconSelector' : '.icon-selector';
                const input = isEdit ? '#edit_icone' : '#icone';
                const preview = isEdit ? '#editPreviewIcon' : '#previewIcon';
                
                document.querySelectorAll(`${selector} .icon-option`).forEach(opt => 
                    opt.classList.remove('active')
                );
                this.classList.add('active');
                
                const icon = this.dataset.icon;
                if (isEdit) {
                    editSelectedIcon = icon;
                } else {
                    selectedIcon = icon;
                }
                
                document.querySelector(input).value = icon;
                document.querySelector(preview).textContent = icon;
            });
        });
    }

    // ====================================================================
    // SELETOR DE COR
    // ====================================================================
    function setupColorPicker() {
        const colorInput = document.getElementById('cor');
        const colorPreview = document.getElementById('colorPreview');
        
        colorInput.addEventListener('input', function() {
            selectedColor = this.value;
            colorPreview.style.backgroundColor = this.value;
        });
        // Inicial
        colorPreview.style.backgroundColor = selectedColor;

        // Edit modal
        const editColorInput = document.getElementById('edit_cor');
        const editColorPreview = document.getElementById('editColorPreview');
        
        editColorInput.addEventListener('input', function() {
            editSelectedColor = this.value;
            editColorPreview.style.backgroundColor = this.value;
        });
    }

    // ====================================================================
    // FORMUL√ÅRIO DE CRIAR CATEGORIA
    // ====================================================================
    function setupCategoryForm() {
        const form = document.getElementById('categoryForm');
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const nome = document.getElementById('nome').value.trim();
            const descricao = document.getElementById('descricao').value.trim();
            
            if (!nome) {
                showNotification('‚ùå Nome √© obrigat√≥rio!', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/categorias', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nome,
                        descricao,
                        cor: selectedColor,
                        icone: selectedIcon
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    form.reset();
                    selectedIcon = 'üìÅ';
                    selectedColor = '#60a5fa';
                    document.querySelector('.icon-selector .icon-option').click();
                    document.getElementById('cor').value = '#60a5fa';
                    document.getElementById('colorPreview').style.backgroundColor = '#60a5fa';
                    
                    loadCategories();
                    showNotification('‚úÖ Categoria criada com sucesso!', 'success');
                } else {
                    showNotification('‚ùå ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showNotification('‚ùå Erro ao criar categoria!', 'error');
            }
        });
    }

    // ====================================================================
    // CARREGAR CATEGORIAS
    // ====================================================================
    async function loadCategories() {
        try {
            const response = await fetch('/api/categorias');
            const result = await response.json();
            
            if (result.success) {
                renderCategories(result.data);
            }
        } catch (error) {
            console.error('Erro:', error);
            document.getElementById('categoriesContainer').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚ö†Ô∏è</div>
                    <h3>Erro ao carregar categorias</h3>
                </div>
            `;
        }
    }

    // ====================================================================
    // RENDERIZAR CATEGORIAS
    // ====================================================================
    function renderCategories(categories) {
        const container = document.getElementById('categoriesContainer');
        if (categories.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìÅ</div>
                    <h3>Nenhuma categoria ainda</h3>
                    <p>Crie sua primeira categoria acima!</p>
                </div>
            `;
            return;
        }
        
        const html = categories.map(cat => `
            <div class="list-item" style="border-left: 5px solid ${cat.cor};">
                <div class="item-content">
                    <div class="category-icon">${cat.icone}</div>
                    <div class="category-name">${escapeHtml(cat.nome)}</div>
                    <div class="category-description">${escapeHtml(cat.descricao || 'Sem descri√ß√£o')}</div>
                    
                    <div class="category-stats">
                        <div class="stat-item">
                            <span>üìä</span>
                            <span>${cat.totalTarefas || 0} tarefas</span>
                        </div>
                        <div class="stat-item">
                            <span>‚úÖ</span>
                            <span>${cat.tarefasConcluidas || 0} conclu√≠das</span>
                        </div>
                    </div>
                </div>
                
                <div class="item-actions">
                    <button class="btn btn-edit" onclick="openEditModal(${cat.id})">
                        ‚úèÔ∏è Editar
                    </button>
                    <button class="btn btn-delete" onclick="deleteCategory(${cat.id})">
                        üóëÔ∏è Excluir
                    </button>
                </div>
            </div>
        `).join('');
        container.innerHTML = html;
    }

    // ====================================================================
    // EDI√á√ÉO DE CATEGORIA
    // ====================================================================
    async function openEditModal(id) {
        try {
            const response = await fetch(`/api/categorias/${id}`);
            const result = await response.json();
            
            if (result.success) {
                const cat = result.data;
                document.getElementById('edit_id').value = cat.id;
                document.getElementById('edit_nome').value = cat.nome;
                document.getElementById('edit_descricao').value = cat.descricao || '';
                document.getElementById('edit_cor').value = cat.cor;
                document.getElementById('edit_icone').value = cat.icone;
                
                editSelectedColor = cat.cor;
                editSelectedIcon = cat.icone;
                
                document.getElementById('editColorPreview').style.backgroundColor = cat.cor;
                document.getElementById('editPreviewIcon').textContent = cat.icone;
                
                // Selecionar √≠cone ativo
                document.querySelectorAll('#editIconSelector .icon-option').forEach(opt => {
                    opt.classList.remove('active');
                    if (opt.dataset.icon === cat.icone) {
                        opt.classList.add('active');
                    }
                });
                document.getElementById('editModal').classList.add('active');
            }
        } catch (error) {
            console.error('Erro:', error);
            showNotification('‚ùå Erro ao carregar categoria!', 'error');
        }
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.remove('active');
    }

    function setupEditForm() {
        const form = document.getElementById('editCategoryForm');
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('edit_id').value;
            const nome = document.getElementById('edit_nome').value.trim();
            const descricao = document.getElementById('edit_descricao').value.trim();
            
            try {
                const response = await fetch(`/api/categorias/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nome,
                        descricao,
                        cor: editSelectedColor,
                        icone: editSelectedIcon
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeEditModal();
                    loadCategories();
                    showNotification('‚úÖ Categoria atualizada!', 'success');
                } else {
                    showNotification('‚ùå ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                showNotification('‚ùå Erro ao atualizar!', 'error');
            }
        });
    }

    // ====================================================================
    // DELETAR CATEGORIA
    // ====================================================================
    async function deleteCategory(id) {
        if (!confirm('Tem certeza? Esta a√ß√£o n√£o pode ser desfeita.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/categorias/${id}`, {
                method: 'DELETE'
            });
            const result = await response.json();
            
            if (result.success) {
                loadCategories();
                showNotification('üóëÔ∏è Categoria exclu√≠da!', 'success');
            } else {
                showNotification('‚ùå ' + result.error, 'error');
            }
        } catch (error) {
            console.error('Erro:', error);
            showNotification('‚ùå Erro ao excluir!', 'error');
        }
    }

    // ====================================================================
    // FUN√á√ïES AUXILIARES
    // ====================================================================
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    // Fechar modal ao clicar fora
    document.getElementById('editModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeEditModal();
        }
    });
</script>