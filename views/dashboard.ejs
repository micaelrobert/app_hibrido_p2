

<div class="container">
    <div class="page-header card">
        <div style="font-size: 5rem; margin-bottom: 25px;">üìä</div>
        <h2>Dashboard Geral</h2>
        <p>Acompanhe seu progresso e visualize suas estat√≠sticas em tempo real</p>
    </div>

    <!-- Loading State -->
    <div id="loadingState" style="text-align: center; padding: 60px;">
        <div class="loading-spinner"></div>
        <p style="margin-top: 20px; font-size: 1.1rem;">Carregando dados...</p>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboardContent" style="display: none;">
        
        <!-- GRID DE DUAS COLUNAS -->
        <div class="dashboard-grid">
            
            <!-- COLUNA DE TAREFAS -->
            <section id="tarefas-section" class="card">
                <h3 style="margin-bottom: 20px;">üìù Resumo de Tarefas</h3>

                <!-- Estat√≠sticas Principais de Tarefas -->
                <div class="stats-grid">
                    <div class="card stat-card">
                        <div class="stat-icon">üìã</div>
                        <div class="stat-number" id="tarefas-total">0</div>
                        <div class="stat-label">Total de Tarefas</div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-number" id="tarefas-concluidas">0</div>
                        <div class="stat-label">Conclu√≠das</div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-icon">‚è≥</div>
                        <div class="stat-number" id="tarefas-pendentes">0</div>
                        <div class="stat-label">Pendentes</div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-number" id="tarefas-taxa">0%</div>
                        <div class="stat-label">Taxa de Conclus√£o</div>
                    </div>
                </div>

                <!-- Barra de Progresso de Tarefas -->
                <div class="progress-container" style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: 600; font-size: 1.1rem;">Progresso de Tarefas</span>
                        <span id="tarefas-progresso-texto" style="font-weight: 700; font-size: 1.2rem;">0%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="tarefas-progresso-barra" style="width: 0%;">
                            <span id="tarefas-progresso-label">0 de 0 conclu√≠das</span>
                        </div>
                    </div>
                </div>

                <!-- Estat√≠sticas por Prioridade -->
                <h4 style="margin: 30px 0 15px 0;">üìä Distribui√ß√£o por Prioridade</h4>
                <div class="priority-stats">
                    <div class="list-item">
                        <div class="priority-label">
                            <span style="font-size: 1.5rem;">üî¥</span>
                            <span>Alta</span>
                        </div>
                        <div class="priority-count" id="tarefas-prioridade-alta">0</div>
                    </div>
                    <div class="list-item">
                        <div class="priority-label">
                            <span style="font-size: 1.5rem;">üü°</span>
                            <span>M√©dia</span>
                        </div>
                        <div class="priority-count" id="tarefas-prioridade-media">0</div>
                    </div>
                    <div class="list-item">
                        <div class="priority-label">
                            <span style="font-size: 1.5rem;">üü¢</span>
                            <span>Baixa</span>
                        </div>
                        <div class="priority-count" id="tarefas-prioridade-baixa">0</div>
                    </div>
                </div>

                <!-- √öltimas Tarefas -->
                <h4 style="margin: 30px 0 15px 0;">üïê √öltimas Tarefas Modificadas</h4>
                <div class="recent-tasks">
                    <div id="tarefas-recentes-lista">
                        <!-- Preenchido via JavaScript -->
                    </div>
                </div>
            </section>
            
            <!-- COLUNA DE PROJETOS -->
            <section id="projetos-section" class="card">
                <h3 style="margin-bottom: 20px;">üöÄ Resumo de Projetos</h3>

                <!-- Estat√≠sticas Principais de Projetos -->
                <div class="stats-grid">
                    <div class="card stat-card">
                        <div class="stat-icon">üìã</div>
                        <div class="stat-number" id="projetos-total">0</div>
                        <div class="stat-label">Total de Projetos</div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-number" id="projetos-concluidos">0</div>
                        <div class="stat-label">Conclu√≠dos</div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-icon">‚ñ∂Ô∏è</div>
                        <div class="stat-number" id="projetos-ativos">0</div>
                        <div class="stat-label">Ativos</div>
                    </div>
                     <div class="card stat-card">
                        <div class="stat-icon">‚è∏Ô∏è</div>
                        <div class="stat-number" id="projetos-pausados">0</div>
                        <div class="stat-label">Pausados</div>
                    </div>
                </div>

                <!-- Barra de Progresso de Projetos -->
                <div class="progress-container" style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: 600; font-size: 1.1rem;">Progresso de Projetos</span>
                        <span id="projetos-progresso-texto" style="font-weight: 700; font-size: 1.2rem;">0%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="projetos-progresso-barra" style="width: 0%;">
                            <span id="projetos-progresso-label">0 de 0 conclu√≠dos</span>
                        </div>
                    </div>
                </div>

                 <!-- Gr√°fico de Pizza (Donut Chart) -->
                <h4 style="margin: 30px 0 15px 0;">üìà Vis√£o Geral (Projetos)</h4>
                <div class="chart-container">
                    <div class="donut-chart">
                        <div class="donut" id="projetos-donutChart">
                            <svg width="200" height="200" viewBox="0 0 200 200">
                                <circle cx="100" cy="100" r="90" fill="none" stroke="#555" stroke-width="30"/>
                                <circle 
                                    id="projetos-completedArc" 
                                    cx="100" 
                                    cy="100" 
                                    r="90" 
                                    fill="none" 
                                    stroke="var(--cor-sucesso, #00ff00)" 
                                    stroke-width="30"
                                    stroke-dasharray="565.48"
                                    stroke-dashoffset="565.48"
                                    transform="rotate(-90 100 100)"
                                    style="transition: stroke-dashoffset 1s ease;"
                                />
                            </svg>
                            <div class="donut-center">
                                <div class="donut-value" id="projetos-chartPercentage">0%</div>
                                <div class="donut-label">Conclu√≠do</div>
                            </div>
                        </div>
                        
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--cor-sucesso, #00ff00);"></div>
                                <div class="legend-text">
                                    <div class="legend-label">Projetos Conclu√≠dos</div>
                                    <div class="legend-value" id="projetos-legendCompleted">0</div>
                                </div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--cor-aviso, #ffff00);"></div>
                                <div class="legend-text">
                                    <div class="legend-label">Projetos Pendentes</div>
                                    <div class="legend-value" id="projetos-legendPending">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- √öltimos Projetos -->
                <h4 style="margin: 30px 0 15px 0;">üïê √öltimos Projetos Modificados</h4>
                <div class="recent-tasks">
                    <div id="projetos-recentes-lista">
                        <!-- Preenchido via JavaScript -->
                    </div>
                </div>

            </section>
        </div> <!-- Fim .dashboard-grid -->


        <!-- A√ß√µes R√°pidas -->
        <div class="card" style="text-align: center; margin-top: 2rem;">
            <h3 style="margin-bottom: 20px;">‚ö° A√ß√µes R√°pidas</h3>
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <a href="/tarefas" class="btn">
                    üìù Gerenciar Tarefas
                </a>
                 <a href="/projetos" class="btn">
                    üöÄ Gerenciar Projetos
                </a>
                <button onclick="location.reload()" class="btn">
                    üîÑ Atualizar Dashboard
                </button>
            </div>
        </div>

    </div>
</div>

<script>
// ============================================================================
// INICIALIZA√á√ÉO
// ============================================================================
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
});

// ============================================================================
// CARREGAR DADOS GERAIS
// ============================================================================
async function loadDashboardData() {
    try {
        // 1. Chamar o novo endpoint unificado
        const response = await fetch('/api/dashboard-stats');
        const result = await response.json();
        
        if (result.success) {
            // 2. Distribuir os dados para as fun√ß√µes de renderiza√ß√£o
            updateTarefasStats(result.data.tarefas);
            updateProjetosStats(result.data.projetos);
            
            // Mostrar conte√∫do e esconder loading
            setTimeout(() => {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
            }, 500);
        } else {
            throw new Error(result.error || 'Falha ao buscar dados');
        }
    } catch (error) {
        console.error('Erro ao carregar dashboard:', error);
        let errorMsg = error.message;
        if (error.name === 'SyntaxError') {
            errorMsg = "N√£o foi poss√≠vel encontrar a API. Verifique seu 'index.js' e 'routes/api.js'.";
        }
        
        document.getElementById('loadingState').innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">‚ö†Ô∏è</div>
                <h3>Erro ao carregar dashboard</h3>
                <p>${errorMsg}</p>
                <button onclick="location.reload()" class="btn" style="margin-top: 20px;">
                    üîÑ Recarregar
                </button>
            </div>
        `;
    }
}

// ============================================================================
// ATUALIZAR DADOS DE TAREFAS
// ============================================================================
function updateTarefasStats(data) {
    if (!data) return;

    // Estat√≠sticas principais
    document.getElementById('tarefas-total').textContent = data.total;
    document.getElementById('tarefas-concluidas').textContent = data.concluidas;
    document.getElementById('tarefas-pendentes').textContent = data.pendentes;
    document.getElementById('tarefas-taxa').textContent = data.percentualConclusao + '%';

    // Barra de progresso
    document.getElementById('tarefas-progresso-texto').textContent = data.percentualConclusao + '%';
    const progressBar = document.getElementById('tarefas-progresso-barra');
    progressBar.style.width = data.percentualConclusao + '%';
    progressBar.textContent = `${data.concluidas} de ${data.total} conclu√≠das`;
    
    if (data.percentualConclusao > 75) progressBar.style.background = 'var(--cor-sucesso, #00ff00)';
    else if (data.percentualConclusao > 40) progressBar.style.background = 'var(--cor-aviso, #ffff00)';
    else progressBar.style.background = 'var(--cor-perigo, #ff0000)';

    // Prioridades
    document.getElementById('tarefas-prioridade-alta').textContent = data.porPrioridade.alta;
    document.getElementById('tarefas-prioridade-media').textContent = data.porPrioridade.media;
    document.getElementById('tarefas-prioridade-baixa').textContent = data.porPrioridade.baixa;

    // √öltimas tarefas
    renderRecentTasks(data.ultimasTarefas);
}

// ============================================================================
// ATUALIZAR DADOS DE PROJETOS
// ============================================================================
function updateProjetosStats(data) {
    if (!data) return;

    // Estat√≠sticas principais
    document.getElementById('projetos-total').textContent = data.total;
    document.getElementById('projetos-concluidos').textContent = data.concluidos;
    document.getElementById('projetos-ativos').textContent = data.ativos;
    document.getElementById('projetos-pausados').textContent = data.pausados;

    // Barra de progresso
    document.getElementById('projetos-progresso-texto').textContent = data.percentualConclusao + '%';
    const progressBar = document.getElementById('projetos-progresso-barra');
    progressBar.style.width = data.percentualConclusao + '%';
    progressBar.textContent = `${data.concluidos} de ${data.total} conclu√≠dos`;

    if (data.percentualConclusao > 75) progressBar.style.background = 'var(--cor-sucesso, #00ff00)';
    else if (data.percentualConclusao > 40) progressBar.style.background = 'var(--cor-aviso, #ffff00)';
    else progressBar.style.background = 'var(--cor-perigo, #ff0000)';
    
    // Gr√°fico donut
    updateDonutChart('projetos-completedArc', data.percentualConclusao);
    document.getElementById('projetos-chartPercentage').textContent = data.percentualConclusao + '%';

    // Legenda
    document.getElementById('projetos-legendCompleted').textContent = `${data.concluidos} conclu√≠dos`;
    document.getElementById('projetos-legendPending').textContent = `${data.pendentes} pendentes`;
}

// ============================================================================
// RENDERIZAR √öLTIMAS TAREFAS
// ============================================================================
function renderRecentTasks(tasks) {
    const container = document.getElementById('tarefas-recentes-lista');
    if (!tasks || tasks.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding: 1rem 0;">
                <div class="empty-state-icon">üìù</div>
                <h3>Nenhuma tarefa ainda</h3>
            </div>
        `;
        return;
    }
    
    const tasksHtml = tasks.map(task => {
        const priorityEmoji = { alta: 'üî¥', media: 'üü°', baixa: 'üü¢' };
        const dataCriacao = new Date(task.dataCriacao).toLocaleDateString('pt-BR', {
            day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'
        });
        const isConcluida = task.status === 'concluida';
        
        return `
            <div class="list-item priority-${task.prioridade}">
                <div class="task-title-row">
                    <div class="task-title-text">
                        ${isConcluida ? '‚úÖ' : '‚è≥'} ${escapeHtml(task.titulo)}
                    </div>
                    <span class="task-status-badge ${isConcluida ? 'completed' : 'pending'}">
                        ${isConcluida ? 'Conclu√≠da' : 'Pendente'}
                    </span>
                </div>
                <div class="task-meta-info">
                    <span>${priorityEmoji[task.prioridade] || '‚ö™'} ${task.prioridade ? (task.prioridade.charAt(0).toUpperCase() + task.prioridade.slice(1)) : 'N/A'}</span>
                    <span>üìÖ ${dataCriacao}</span>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = tasksHtml;
}

// ============================================================================
// FUN√á√ïES AUXILIARES
// ============================================================================
function updateDonutChart(elementId, percentage) {
    const circle = document.getElementById(elementId);
    if (!circle) return;
    const circumference = 565.48; // 2 * œÄ * r (r = 90)
    const offset = circumference - (percentage / 100 * circumference);
    
    setTimeout(() => {
        circle.style.strokeDashoffset = offset;
    }, 100); 
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>