<%- contentFor('body') %>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>

<div class="container-lista">
  <div class="terminal-header">
    <div class="terminal-title">system@dashboard:~</div>
    <div class="terminal-controls">
      <div class="control-btn minimize"></div>
      <div class="control-btn maximize"></div>
      <div class="control-btn close"></div>
    </div>
  </div>

  <div class="terminal-body dashboard-container">
    <h1 class="glitch" data-text="[ Dashboard de Progresso ]">[ Dashboard de Progresso ]</h1>
    <p class="console-text" id="dashboard-status">C:\\> Carregando_dados_do_sistema...</p>

    <div class="dashboard-grid">
      <div class="stat-card">
        <h2 class="card-title">Tarefas</h2>
        <div class="stat-group">
          <p>Total: <span id="tarefas-total" class="stat-value">0</span></p>
          <p>Concluídas: <span id="tarefas-concluidas" class="stat-value" style="color: #00ff00;">0</span></p>
          <p>Pendentes: <span id="tarefas-pendentes" class="stat-value" style="color: #ff0000;">0</span></p>
        </div>
        <h3 class="card-subtitle">Prioridades (Pendentes)</h3>
        <div class="stat-group priority-group">
          <p>Alta: <span id="tarefas-prio-alta" class="stat-value p-alta">0</span></p>
          <p>Média: <span id="tarefas-prio-media" class="stat-value p-media">0</span></p>
          <p>Baixa: <span id="tarefas-prio-baixa" class="stat-value p-baixa">0</span></p>
        </div>
      </div>

      <div class="stat-card">
        <h2 class="card-title">Projetos</h2>
        <div class="stat-group">
          <p>Total: <span id="projetos-total" class="stat-value">0</span></p>
          <p>Concluídos: <span id="projetos-concluidos" class="stat-value" style="color: #00ff00;">0</span></p>
          <p>Pendentes: <span id="projetos-pendentes" class="stat-value" style="color: #ff0000;">0</span></p>
        </div>
        <h3 class="card-subtitle">Prioridades (Pendentes)</h3>
        <div class="stat-group priority-group">
          <p>Alta: <span id="projetos-prio-alta" class="stat-value p-alta">0</span></p>
          <p>Média: <span id="projetos-prio-media" class="stat-value p-media">0</span></p>
          <p>Baixa: <span id="projetos-prio-baixa" class="stat-value p-baixa">0</span></p>
        </div>
      </div>
    </div>

    <div class="stat-card chart-container">
      <h2 class="card-title">Progresso Total (Tarefas + Projetos)</h2>
      <canvas id="progressoTotalChart"></canvas>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const statusElement = document.getElementById('dashboard-status');
    
    try {
      // 1. Buscar os dados da API unificada
      const response = await fetch('/api/dashboard-stats');
      if (!response.ok) {
        throw new Error(`Falha ao buscar dados: ${response.statusText}`);
      }
      
      const jsonResponse = await response.json();
      if (!jsonResponse.success || !jsonResponse.data) {
        throw new Error('Resposta da API inválida.');
      }
      
      const { tarefas: t, projetos: p } = jsonResponse.data;
      statusElement.textContent = "C:\\> Dados_carregados_com_sucesso. Renderizando_gráficos...";
      statusElement.style.color = '#00ff00'; // Verde hacker para sucesso

      // 2. Popular Card de Tarefas
      document.getElementById('tarefas-total').textContent = t.total || 0;
      document.getElementById('tarefas-concluidas').textContent = t.concluidas || 0;
      document.getElementById('tarefas-pendentes').textContent = t.pendentes || 0;
      document.getElementById('tarefas-prio-alta').textContent = t.prioridades?.Alta || 0;
      document.getElementById('tarefas-prio-media').textContent = t.prioridades?.Media || 0;
      document.getElementById('tarefas-prio-baixa').textContent = t.prioridades?.Baixa || 0;

      // 3. Popular Card de Projetos
      document.getElementById('projetos-total').textContent = p.total || 0;
      document.getElementById('projetos-concluidos').textContent = p.concluidas || 0;
      document.getElementById('projetos-pendentes').textContent = p.pendentes || 0;
      document.getElementById('projetos-prio-alta').textContent = p.prioridades?.Alta || 0;
      document.getElementById('projetos-prio-media').textContent = p.prioridades?.Media || 0;
      document.getElementById('projetos-prio-baixa').textContent = p.prioridades?.Baixa || 0;

      // 4. Renderizar Gráfico Combinado
      const ctx = document.getElementById('progressoTotalChart').getContext('2d');
      
      // Configurações globais do Chart.js para o tema hacker
      Chart.defaults.color = '#00ff00'; // Cor do texto (labels, tooltips)
      Chart.defaults.borderColor = 'rgba(159, 0, 255, 0.2)'; // Cor das linhas do grid

      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Pendentes', 'Concluídas'],
          datasets: [{
            label: 'Progresso Total',
            data: [
              (t.pendentes || 0) + (p.pendentes || 0),
              (t.concluidas || 0) + (p.concluidas || 0)
            ],
            backgroundColor: [
              'rgba(255, 0, 0, 0.7)',  // Vermelho para Pendentes
              'rgba(0, 255, 0, 0.7)'   // Verde para Concluídas
            ],
            borderColor: '#9f00ff', // Borda roxa
            borderWidth: 2,
            hoverOffset: 4,
            hoverBorderColor: '#00ff00'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '60%', // Cria o "buraco" do doughnut
          plugins: {
            legend: {
              position: 'top',
              labels: {
                color: '#00ff00',
                font: {
                  size: 14,
                  family: "'Courier New', Courier, monospace"
                }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#9f00ff',
              bodyColor: '#00ff00',
              borderColor: '#9f00ff',
              borderWidth: 1
            }
          }
        }
      });

    } catch (error) {
      console.error('Erro ao carregar dashboard:', error);
      statusElement.textContent = `C:\\> ERRO_AO_CARREGAR_DADOS: ${error.message}`;
      statusElement.style.color = '#ff0000'; // Vermelho para erro
    }
  });
</script>