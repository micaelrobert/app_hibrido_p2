<%- include('layout', { titulo: titulo }) %>
<%- include('partials/header') %>

<div class="container">
    <div class="page-header card">
        <div style="font-size: 5rem; margin-bottom: 25px;">ğŸ“Š</div>
        <h2>Dashboard</h2>
        <p>Acompanhe seu progresso e visualize suas estatÃ­sticas em tempo real</p>
    </div>

    <div id="loadingState" style="text-align: center; padding: 60px;">
        <div class="loading-spinner"></div>
        <p style="margin-top: 20px; font-size: 1.1rem;">Carregando dados...</p>
    </div>

    <div id="dashboardContent" style="display: none;">
        
        <div class="stats-grid">
            <div class="card stat-card">
                <div class="stat-icon">ğŸ“‹</div>
                <div class="stat-number" id="totalTasks">0</div>
                <div class="stat-label">Total de Tarefas</div>
            </div>
            
            <div class="card stat-card">
                <div class="stat-icon">âœ…</div>
                <div class="stat-number" id="completedTasks">0</div>
                <div class="stat-label">ConcluÃ­das</div>
            </div>
            
            <div class="card stat-card">
                <div class="stat-icon">â³</div>
                <div class="stat-number" id="pendingTasks">0</div>
                <div class="stat-label">Pendentes</div>
            </div>
            
            <div class="card stat-card">
                <div class="stat-icon">ğŸ“ˆ</div>
                <div class="stat-number" id="completionRate">0%</div>
                <div class="stat-label">Taxa de ConclusÃ£o</div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 20px;">ğŸ¯ Progresso Geral</h3>
            <div class="progress-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="font-weight: 600; font-size: 1.1rem;">ConclusÃ£o de Tarefas</span>
                    <span id="progressText" style="font-weight: 700; font-size: 1.2rem;">0%</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar" style="width: 0%;">
                        <span id="progressLabel">0 de 0 concluÃ­das</span>
                    </div>
                </div>
                
                <h4 style="margin: 30px 0 15px 0;">ğŸ“Š DistribuiÃ§Ã£o por Prioridade</h4>
                <div class="priority-stats">
                    <div class="list-item">
                        <div class="priority-label">
                            <span style="font-size: 1.5rem;">ğŸ”´</span>
                            <span>Alta</span>
                        </div>
                        <div class="priority-count" id="highPriority">0</div>
                    </div>
                    <div class="list-item">
                        <div class="priority-label">
                            <span style="font-size: 1.5rem;">ğŸŸ¡</span>
                            <span>MÃ©dia</span>
                        </div>
                        <div class="priority-count" id="mediumPriority">0</div>
                    </div>
                    <div class="list-item">
                        <div class="priority-label">
                            <span style="font-size: 1.5rem;">ğŸŸ¢</span>
                            <span>Baixa</span>
                        </div>
                        <div class="priority-count" id="lowPriority">0</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 20px;">ğŸ“ˆ VisÃ£o Geral</h3>
            <div class="chart-container">
                <div class="donut-chart">
                    <div class="donut" id="donutChart">
                        <svg width="200" height="200" viewBox="0 0 200 200">
                            <circle cx="100" cy="100" r="90" fill="none" stroke="#555" stroke-width="30"/>
                            <circle 
                                id="completedArc" 
                                cx="100" 
                                cy="100" 
                                r="90" 
                                fill="none" 
                                stroke="#00ff00" 
                                stroke-width="30"
                                stroke-dasharray="565.48"
                                stroke-dashoffset="565.48"
                                transform="rotate(-90 100 100)"
                                style="transition: stroke-dashoffset 1s ease;"
                            />
                        </svg>
                        <div class="donut-center">
                            <div class="donut-value" id="chartPercentage">0%</div>
                            <div class="donut-label">ConcluÃ­do</div>
                        </div>
                    </div>
                    
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #00ff00;"></div>
                            <div class="legend-text">
                                <div class="legend-label">Tarefas ConcluÃ­das</div>
                                <div class="legend-value" id="legendCompleted">0 tarefas</div>
                            </div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ffff00;"></div>
                            <div class="legend-text">
                                <div class="legend-label">Tarefas Pendentes</div>
                                <div class="legend-value" id="legendPending">0 tarefas</div>
                            </div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #00ffff;"></div>
                            <div class="legend-text">
                                <div class="legend-label">Total</div>
                                <div class="legend-value" id="legendTotal">0 tarefas</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 20px;">ğŸ• Ãšltimas 5 Tarefas</h3>
            <div class="recent-tasks">
                <div id="recentTasksList">
                    </div>
            </div>
        </div>

        <div class="card" style="text-align: center;">
            <h3 style="margin-bottom: 20px;">âš¡ AÃ§Ãµes RÃ¡pidas</h3>
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <a href="/tarefas" class="btn">
                    ğŸ“ Gerenciar Tarefas
                </a>
                <button onclick="location.reload()" class="btn">
                    ğŸ”„ Atualizar Dashboard
                </button>
            </div>
        </div>

    </div>
</div>

<script>
// ============================================================================
// INICIALIZAÃ‡ÃƒO
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
});

// ============================================================================
// CARREGAR DADOS DO DASHBOARD
// ============================================================================

async function loadDashboardData() {
    try {
        const response = await fetch('/api/tarefas/stats');
        const result = await response.json();
        if (result.success) {
            updateDashboard(result.data);
            // Mostrar conteÃºdo e esconder loading
            setTimeout(() => {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
            }, 500);
        }
    } catch (error) {
        console.error('Erro ao carregar dashboard:', error);
        document.getElementById('loadingState').innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">âš ï¸</div>
                <h3>Erro ao carregar dashboard</h3>
                <p>Tente recarregar a pÃ¡gina</p>
                <button onclick="location.reload()" class="btn" style="margin-top: 20px;">
                    ğŸ”„ Recarregar
                </button>
            </div>
        `;
    }
}

// ============================================================================
// ATUALIZAR DASHBOARD
// ============================================================================

function updateDashboard(data) {
    // EstatÃ­sticas principais
    document.getElementById('totalTasks').textContent = data.total;
    document.getElementById('completedTasks').textContent = data.concluidas;
    document.getElementById('pendingTasks').textContent = data.pendentes;
    document.getElementById('completionRate').textContent = data.percentualConclusao + '%';

    // Barra de progresso
    document.getElementById('progressText').textContent = data.percentualConclusao + '%';
    const progressBar = document.getElementById('progressBar');
    progressBar.style.width = data.percentualConclusao + '%';
    progressBar.textContent = `${data.concluidas} de ${data.total} concluÃ­das`;
    // Mudar a cor da barra de progresso
    if (data.percentualConclusao > 75) {
        progressBar.style.background = 'var(--cor-sucesso, #00ff00)';
    } else if (data.percentualConclusao > 40) {
        progressBar.style.background = 'var(--cor-aviso, #ffff00)';
    } else {
        progressBar.style.background = 'var(--cor-perigo, #ff0000)';
    }


    // Prioridades
    document.getElementById('highPriority').textContent = data.porPrioridade.alta;
    document.getElementById('mediumPriority').textContent = data.porPrioridade.media;
    document.getElementById('lowPriority').textContent = data.porPrioridade.baixa;

    // GrÃ¡fico donut
    updateDonutChart(data.percentualConclusao);
    document.getElementById('chartPercentage').textContent = data.percentualConclusao + '%';

    // Legenda
    document.getElementById('legendCompleted').textContent = `${data.concluidas} tarefas`;
    document.getElementById('legendPending').textContent = `${data.pendentes} tarefas`;
    document.getElementById('legendTotal').textContent = `${data.total} tarefas`;

    // Ãšltimas tarefas
    renderRecentTasks(data.ultimasTarefas);
}

// ============================================================================
// ATUALIZAR GRÃFICO DONUT
// ============================================================================

function updateDonutChart(percentage) {
    const circle = document.getElementById('completedArc');
    const circumference = 565.48; // 2 * Ï€ * r (r = 90)
    const offset = circumference - (percentage / 100 * circumference);
    
    // Hack para forÃ§ar a animaÃ§Ã£o
    setTimeout(() => {
        circle.style.strokeDashoffset = offset;
    }, 100); 
}

// ============================================================================
// RENDERIZAR ÃšLTIMAS TAREFAS
// ============================================================================

function renderRecentTasks(tasks) {
    const container = document.getElementById('recentTasksList');
    if (tasks.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“</div>
                <h3>Nenhuma tarefa ainda</h3>
                <p>Comece criando sua primeira tarefa!</p>
                <a href="/tarefas" class="btn" style="margin-top: 20px;">
                    â• Criar Tarefa
                </a>
            </div>
        `;
        return;
    }
    
    const tasksHtml = tasks.map(task => {
        const priorityEmoji = {
            alta: 'ğŸ”´',
            media: 'ğŸŸ¡',
            baixa: 'ğŸŸ¢'
        };
        
        const dataCriacao = new Date(task.dataCriacao).toLocaleDateString('pt-BR', {
            day: '2-digit',
            month: 'short',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // Usando classes .list-item e adicionando classes de prioridade
        return `
            <div class="list-item priority-${task.prioridade}">
                
                <div class="task-title-row">
                    <div class="task-title-text">
                        ${task.concluida ? 'âœ…' : 'â³'} ${escapeHtml(task.titulo)}
                    </div>
                    <span class="task-status-badge ${task.concluida ? 'completed' : 'pending'}">
                        ${task.concluida ? 'ConcluÃ­da' : 'Pendente'}
                    </span>
                </div>
                ${task.descricao ? `<div class="task-description">${escapeHtml(task.descricao)}</div>` : ''}
                <div class="task-meta-info">
                    <span>${priorityEmoji[task.prioridade]} ${task.prioridade.charAt(0).toUpperCase() + task.prioridade.slice(1)}</span>
                    <span>ğŸ“… ${dataCriacao}</span>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = tasksHtml;
}

// ============================================================================
// FUNÃ‡Ã•ES AUXILIARES
// ============================================================================

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>